---
export interface Props {
  locale?: 'en' | 'fr' | 'ar';
}

const { locale = 'en' } = Astro.props;

import { useTranslations } from '../i18n/ui.ts';
import faqData from '../content/faq.json';

const t = useTranslations(locale);
const isRTL = locale === 'ar';

// Fallback messages for each language
const fallbackMessages = {
  fr: "Je n'ai pas trouvé de réponse, veuillez nous contacter à",
  en: "I did not find an answer, please contact us at", 
  ar: "لم أجد إجابة، المرجو التواصل معنا عبر البريد الإلكتروني"
};

// Get top 3 actual questions for suggestions (skip greetings/thanks)
const suggestedQuestions = faqData
  .filter(item => !['greeting', 'thanks'].includes(item.id))
  .slice(0, 3);
---

<!-- Chatbot Widget -->
<div id="chatbot-widget" class="fixed bottom-4 right-4 z-50" data-locale={locale}>
  <!-- Chat Toggle Button -->
  <button
    id="chat-toggle"
    class="bg-brand-primary hover:bg-brand-primaryDark text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-brand-accent focus:ring-offset-2"
    aria-label={t('chatbot.title')}
  >
    <svg id="chat-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.906-1.287A6.967 6.967 0 0012 21c-2.331 0-4.512-.645-6.374-1.766l-.227-.133C3.142 18.156 2 16.154 2 14V7a5 5 0 015-5h10a5 5 0 015 5v5z"/>
    </svg>
    <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>

  <!-- Chat Window -->
  <div
    id="chat-window"
    class={`absolute bottom-16 ${isRTL ? 'left-0' : 'right-0'} w-96 max-w-[calc(100vw-2rem)] bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 hidden animate-in slide-in-from-bottom-4 duration-300`}
  >
    <!-- Chat Header -->
    <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-brand-primary text-white rounded-t-2xl">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 bg-brand-accent rounded-full flex items-center justify-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-sm">{t('chatbot.title')}</h3>
          <p class="text-xs opacity-90">CIRIV 2026</p>
        </div>
      </div>
      <button
        id="chat-minimize"
        class="text-white hover:text-slate-200 transition-colors p-1 rounded"
        aria-label={t('chatbot.minimize')}
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
    </div>

    <!-- Chat Messages -->
    <div id="chat-messages" class="h-80 overflow-y-auto p-4 space-y-3">
      <!-- Welcome Message -->
      <div class="flex items-start space-x-2">
        <div class="w-8 h-8 bg-brand-primary text-white rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="bg-slate-100 dark:bg-slate-700 rounded-lg p-3 max-w-xs">
          <p class="text-sm text-slate-900 dark:text-slate-100">{t('chatbot.welcome')}</p>
        </div>
      </div>

      <!-- Suggested Questions -->
      <div id="suggested-questions" class="space-y-2">
        <div class="text-xs text-slate-500 dark:text-slate-400 px-2 py-1">
          {locale === 'fr' ? 'Questions fréquentes :' : locale === 'en' ? 'Frequently asked:' : 'أسئلة شائعة:'}
        </div>
        {suggestedQuestions.map((faq) => (
          <button
            class="suggested-question-btn w-full text-left bg-slate-50 dark:bg-slate-600 hover:bg-slate-100 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-200 rounded-lg p-3 text-sm transition-colors border border-slate-200 dark:border-slate-600"
            data-question={faq.question[locale] || faq.question.en}
            data-answer={faq.answer[locale] || faq.answer.en}
          >
            {faq.question[locale] || faq.question.en}
          </button>
        ))}
      </div>
    </div>

    <!-- Typing Indicator -->
    <div id="typing-indicator" class="px-4 pb-2 hidden">
      <div class="flex items-start space-x-2">
        <div class="w-8 h-8 bg-brand-primary text-white rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="bg-slate-100 dark:bg-slate-700 rounded-lg p-3">
          <div class="flex space-x-1">
            <div class="w-2 h-2 bg-slate-400 dark:bg-slate-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
            <div class="w-2 h-2 bg-slate-400 dark:bg-slate-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
            <div class="w-2 h-2 bg-slate-400 dark:bg-slate-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Input -->
    <div class="p-4 border-t border-slate-200 dark:border-slate-700">
      <form id="chat-form" class="flex space-x-2">
        <input
          type="text"
          id="chat-input"
          placeholder={t('chatbot.placeholder')}
          class={`flex-1 px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 text-sm ${isRTL ? 'text-right' : 'text-left'}`}
          autocomplete="off"
        />
        <button
          type="submit"
          class="px-4 py-2 bg-brand-primary hover:bg-brand-primaryDark text-white rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-brand-accent focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label={t('chatbot.send')}
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>

<script define:vars={{ faqData, locale, fallbackMessages, translations: { 
  fallback: t('chatbot.fallback'),
  typing: t('chatbot.typing')
} }}>
  class Chatbot {
    constructor(faqData, locale, fallbackMessages, translations) {
      this.faqData = faqData;
      this.locale = locale;
      this.fallbackMessages = fallbackMessages;
      this.translations = translations;
      this.isOpen = false;
      this.init();
    }

    init() {
      this.bindEvents();
      this.setupSuggestedQuestions();
    }

    setupSuggestedQuestions() {
      const suggestedBtns = document.querySelectorAll('.suggested-question-btn');
      suggestedBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const question = e.target.dataset.question;
          const answer = e.target.dataset.answer;
          
          // Add user question to chat
          this.addMessage(question, 'user');
          
          // Remove suggested questions
          document.getElementById('suggested-questions')?.remove();
          
          // Show typing indicator
          this.showTyping();
          
          // Add bot response after delay
          setTimeout(() => {
            this.hideTyping();
            this.addMessage(answer, 'bot');
          }, 800);
        });
      });
    }

    bindEvents() {
      const chatToggle = document.getElementById('chat-toggle');
      const chatWindow = document.getElementById('chat-window');
      const chatMinimize = document.getElementById('chat-minimize');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');

      chatToggle?.addEventListener('click', () => this.toggleChat());
      chatMinimize?.addEventListener('click', () => this.toggleChat());
      chatForm?.addEventListener('submit', (e) => this.handleSubmit(e));
      
      // Auto-focus input when chat opens
      chatInput?.addEventListener('focus', () => {
        setTimeout(() => chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
      });
    }

    toggleChat() {
      const chatWindow = document.getElementById('chat-window');
      const chatIcon = document.getElementById('chat-icon');
      const closeIcon = document.getElementById('close-icon');
      const chatInput = document.getElementById('chat-input');

      if (!chatWindow) return;

      this.isOpen = !this.isOpen;

      if (this.isOpen) {
        chatWindow.classList.remove('hidden');
        chatIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');
        setTimeout(() => chatInput?.focus(), 100);
      } else {
        chatWindow.classList.add('hidden');
        chatIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
      }
    }

    async handleSubmit(e) {
      e.preventDefault();
      const chatInput = document.getElementById('chat-input');
      const message = chatInput?.value.trim();
      
      if (!message) return;

      // Remove suggested questions if still visible
      document.getElementById('suggested-questions')?.remove();

      // Add user message
      this.addMessage(message, 'user');
      chatInput.value = '';

      // Show typing indicator
      this.showTyping();

      // Simulate thinking time
      await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));

      // Hide typing indicator
      this.hideTyping();

      // Find and add bot response
      const response = this.findAnswer(message);
      this.addMessage(response, 'bot');
    }

    findAnswer(query) {
      const normalizedQuery = query.toLowerCase().trim();
      const queryWords = normalizedQuery.split(' ');
      
      // Enhanced search with keywords
      const results = this.faqData
        .map(item => {
          const question = (item.question[this.locale] || item.question.en).toLowerCase();
          const keywords = item.keywords || [];
          
          let score = 0;
          
          // Score based on question text matches
          queryWords.forEach(word => {
            if (question.includes(word)) {
              score += word.length;
            }
          });
          
          // Score based on keyword matches (higher weight)
          keywords.forEach(keyword => {
            const keywordLower = keyword.toLowerCase();
            queryWords.forEach(word => {
              if (keywordLower.includes(word) || word.includes(keywordLower)) {
                score += keyword.length * 2; // Higher weight for keyword matches
              }
            });
            
            // Exact keyword match gets bonus
            if (normalizedQuery.includes(keywordLower)) {
              score += keyword.length * 3;
            }
          });
          
          // Bonus for exact substring match in question
          if (question.includes(normalizedQuery)) {
            score += normalizedQuery.length * 2;
          }
          
          return { item, score };
        })
        .filter(result => result.score > 0)
        .sort((a, b) => b.score - a.score);
      
      // Return best match if score is good enough
      if (results.length > 0 && results[0].score > 2) {
        const bestMatch = results[0].item;
        return bestMatch.answer[this.locale] || bestMatch.answer.en;
      }
      
      // Fallback response with mailto link
      const fallbackText = this.fallbackMessages[this.locale];
      return `${fallbackText} <a href="mailto:registration@ciriv.org" class="text-brand-primary hover:text-brand-primaryDark underline">registration@ciriv.org</a>`;
    }

    addMessage(content, sender) {
      const messagesContainer = document.getElementById('chat-messages');
      if (!messagesContainer) return;

      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start space-x-2';
      
      if (sender === 'user') {
        messageDiv.className = 'flex items-start space-x-2 justify-end';
        messageDiv.innerHTML = `
          <div class="bg-brand-primary text-white rounded-lg p-3 max-w-xs">
            <p class="text-sm">${this.escapeHtml(content)}</p>
          </div>
          <div class="w-8 h-8 bg-slate-300 dark:bg-slate-600 rounded-full flex items-center justify-center flex-shrink-0">
            <svg class="w-4 h-4 text-slate-600 dark:text-slate-300" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
            </svg>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="w-8 h-8 bg-brand-primary text-white rounded-full flex items-center justify-center flex-shrink-0">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="bg-slate-100 dark:bg-slate-700 rounded-lg p-3 max-w-xs">
            <p class="text-sm text-slate-900 dark:text-slate-100">${content}</p>
          </div>
        `;
      }

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    showTyping() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.classList.remove('hidden');
        document.getElementById('chat-messages')?.scrollTo({
          top: document.getElementById('chat-messages').scrollHeight,
          behavior: 'smooth'
        });
      }
    }

    hideTyping() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.classList.add('hidden');
      }
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // Initialize chatbot when DOM is ready
  let chatbot;
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      chatbot = new Chatbot(faqData, locale, fallbackMessages, translations);
    });
  } else {
    chatbot = new Chatbot(faqData, locale, fallbackMessages, translations);
  }
</script>

<style>
  /* Custom animations for chatbot */
  @keyframes slide-in-from-bottom-4 {
    from {
      transform: translateY(1rem);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .animate-in {
    animation-duration: 300ms;
    animation-fill-mode: both;
  }

  .slide-in-from-bottom-4 {
    animation-name: slide-in-from-bottom-4;
  }

  /* Smooth scrolling for chat messages */
  #chat-messages {
    scroll-behavior: smooth;
  }

  /* Custom scrollbar for chat messages */
  #chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  #chat-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  #chat-messages::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }

  .dark #chat-messages::-webkit-scrollbar-thumb {
    background-color: rgba(75, 85, 99, 0.5);
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    #chat-window {
      width: calc(100vw - 2rem);
      right: 1rem;
      left: 1rem;
    }
  }
</style>
