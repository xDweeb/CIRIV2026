---
export interface Props { locale?: 'en'|'fr'|'ar' }
const { locale='en' } = Astro.props;

import { useTranslations } from '../i18n/ui.ts';
import faqData from '../content/faq.json';

const t = useTranslations(locale);
const isRTL = locale === 'ar';

const fallbackMessages = {
  fr: "Je n'ai pas trouvé de réponse, veuillez nous contacter à",
  en: "I did not find an answer, please contact us at",
  ar: "لم أجد إجابة، المرجو التواصل معنا عبر البريد الإلكتروني"
};

const suggestedQuestions = faqData
  .filter(i => !['greeting','thanks'].includes(i.id))
  .slice(0,3);
---

<div id="chatbot-widget"
     class={`fixed bottom-4 z-50 chatbot-container ${isRTL?'left-2 sm:left-4':'right-2 sm:right-4'}`}
     data-locale={locale}>
  <!-- Toggle Button -->
  <button id="chat-toggle"
    class="chatbot-button bg-brand-primary hover:bg-brand-primaryDark text-white p-3 sm:p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-brand-accent focus:ring-offset-2"
    aria-label={t('chatbot.title')}>
    <svg id="chat-icon" class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.906-1.287A6.967 6.967 0 0012 21c-2.331 0-4.512-.645-6.374-1.766l-.227-.133C3.142 18.156 2 16.154 2 14V7a5 5 0 015-5h10a5 5 0 015 5v5z"/>
    </svg>
    <svg id="close-icon" class="w-5 h-5 sm:w-6 sm:h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>

  <!-- Chat Window -->
  <div id="chat-window"
       class={`chat-window hidden absolute bottom-14 sm:bottom-16 ${isRTL?'left-0':'right-0'} w-80 sm:w-96 max-w-[calc(100vw-1rem)] sm:max-w-[calc(100vw-2rem)] bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col`}>
    <!-- Header -->
    <div class="chat-header flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-brand-primary text-white rounded-t-2xl">
      <div class={`flex items-center ${isRTL?'space-x-reverse space-x-3':'space-x-3'}`}>
        <div class="w-8 h-8 bg-brand-accent rounded-full flex items-center justify-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-sm">{t('chatbot.title')}</h3>
          <p class="text-xs opacity-90">CIRIV 2026</p>
        </div>
      </div>
      <button id="chat-minimize" class="p-2 rounded hover:bg-white/10 focus:outline-none transition-colors" aria-label="Close chat">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Messages Area -->
    <div id="chat-messages" class="chat-body flex-1 overflow-y-auto p-4 space-y-3">
      <!-- Welcome -->
      <div class={`flex items-start space-x-2 ${isRTL?'space-x-reverse':''}`}>
        <div class="w-8 h-8 bg-brand-primary text-white rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="bg-slate-100 rounded-lg p-3 max-w-xs">
          <p class="text-sm text-slate-900">{t('chatbot.welcome')}</p>
        </div>
      </div>

      <!-- Suggestions -->
      <div id="suggested-questions" class="space-y-2">
        <div class="text-xs text-slate-500 px-2 py-1">
          {locale==='fr'?'Questions fréquentes :':locale==='en'?'Frequently asked:':'أسئلة شائعة:'}
        </div>
        {suggestedQuestions.map(faq => (
          <button
            class={`suggested-question-btn w-full bg-slate-50 hover:bg-slate-100 text-slate-700 rounded-lg p-3 text-sm transition-colors border border-slate-200 ${isRTL?'text-right':'text-left'}`}
            data-question={faq.question[locale]||faq.question.en}
            data-answer={faq.answer[locale]||faq.answer.en}>
            {faq.question[locale]||faq.question.en}
          </button>
        ))}
      </div>
    </div>

    <!-- Typing -->
    <div id="typing-indicator" class="px-4 pb-2 hidden">
      <div class={`flex items-start space-x-2 ${isRTL?'space-x-reverse':''}`}>
        <div class="w-8 h-8 bg-brand-primary text-white rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="bg-slate-100 rounded-lg p-3">
          <div class="flex space-x-1">
            <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay:0ms"></span>
            <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay:150ms"></span>
            <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay:300ms"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="chat-input-wrapper relative border-t border-gray-200">
      <form id="chat-form" class={`chat-form flex gap-2 p-3 ${isRTL?'flex-row-reverse':''}`}>
        <input id="chat-input" type="text"
          autocomplete="off"
          placeholder={t('chatbot.placeholder')}
          class={`flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-transparent bg-white text-slate-900 placeholder-slate-500 text-sm ${isRTL?'text-right':'text-left'}`} />
        <button type="submit"
          class="send-btn px-4 py-2 bg-brand-primary hover:bg-brand-primaryDark text-white rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-brand-accent focus:ring-offset-2 disabled:opacity-50"
          aria-label={t('chatbot.send')}>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>

<script define:vars={{ faqData, locale, fallbackMessages }}>
class Chatbot {
  constructor(faqData, locale, fallbackMessages){
    this.faqData = faqData;
    this.locale = locale;
    this.fallback = fallbackMessages;
    this.isOpen = false;
    this.mobile = window.matchMedia('(max-width: 767px)').matches;
    this.init();
  }

  init(){
    this.cache();
    this.bind();
    this.setupSuggested();
    this.setupViewportHandlers();
  }

  cache(){
    this.widget = document.getElementById('chatbot-widget');
    this.windowEl = document.getElementById('chat-window');
    this.toggleBtn = document.getElementById('chat-toggle');
    this.minBtn = document.getElementById('chat-minimize');
    this.chatIcon = document.getElementById('chat-icon');
    this.closeIcon = document.getElementById('close-icon');
    this.form = document.getElementById('chat-form');
    this.input = document.getElementById('chat-input');
    this.messages = document.getElementById('chat-messages');
    this.typing = document.getElementById('typing-indicator');
    this.suggestions = document.getElementById('suggested-questions');
    this.header = this.windowEl?.querySelector('.chat-header');
    this.inputWrap = this.windowEl?.querySelector('.chat-input-wrapper');
  }

  bind(){
    this.toggleBtn?.addEventListener('click',()=>this.toggle());
    this.minBtn?.addEventListener('click',()=>this.toggle());
    this.form?.addEventListener('submit',(e)=>this.submit(e));

    // Keep input visible above keyboard
    this.input?.addEventListener('focus', ()=> this.onFocus());
    this.input?.addEventListener('blur', ()=> this.onBlur());
  }

  setupSuggested(){
    document.querySelectorAll('.suggested-question-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const q = btn.getAttribute('data-question');
        const a = btn.getAttribute('data-answer');
        this.addMessage(q,'user');
        this.removeSuggestions();
        this.showTyping();
        setTimeout(()=>{
          this.hideTyping();
            this.addMessage(a,'bot');
        },600);
      });
    });
  }

  setupViewportHandlers(){
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize', ()=> this.adjustForKeyboard());
    }
    window.addEventListener('orientationchange', ()=> setTimeout(()=>this.adjustForKeyboard(),300));
    window.addEventListener('resize', ()=> {
      this.mobile = window.matchMedia('(max-width: 767px)').matches;
      this.adjustForKeyboard();
    });
  }

  toggle(){
    if(!this.windowEl) return;
    this.isOpen = !this.isOpen;
    if(this.isOpen){
      this.windowEl.classList.remove('hidden');
      this.chatIcon?.classList.add('hidden');
      this.closeIcon?.classList.remove('hidden');
      this.widget?.classList.add('chat-open');
      if(this.mobile){
        this.windowEl.classList.add('mobile-full');
        this.adjustForKeyboard();
      }
      setTimeout(()=>this.input?.focus(),120);
      this.scrollBottom(true);
    } else {
      this.windowEl.classList.add('hidden');
      this.chatIcon?.classList.remove('hidden');
      this.closeIcon?.classList.add('hidden');
      this.widget?.classList.remove('chat-open');
      this.windowEl.classList.remove('mobile-full','keyboard-shift');
      document.body.classList.remove('chatlock');
      this.windowEl.style.setProperty('--vvh','');
    }
  }

  submit(e){
    e.preventDefault();
    const val = this.input.value.trim();
    if(!val) return;
    this.addMessage(val,'user');
    this.removeSuggestions();
    this.input.value='';
    this.showTyping();
    setTimeout(()=>{
      this.hideTyping();
      const ans = this.findAnswer(val);
      this.addMessage(ans,'bot');
    }, 600 + Math.random()*600);
  }

  removeSuggestions(){
    if(this.suggestions){
      this.suggestions.remove();
      this.suggestions = null;
    }
  }

  showTyping(){
    if(!this.typing) return;
    this.typing.classList.remove('hidden');
    this.scrollBottom();
  }

  hideTyping(){
    if(!this.typing) return;
    this.typing.classList.add('hidden');
  }

  // Smart FAQ matching with fuzzy search, typo tolerance, and multilingual support
  findAnswer(q){
    // ----------------------------
    // 1. Text normalization utilities
    // ----------------------------
    const removeAccents = (str) => 
      str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    
    const removeArabicDiacritics = (str) => 
      str.replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, '')
         .replace(/ـ/g, ''); // remove tashkeel & tatweel
    
    const collapseRepeats = (word) => 
      word.replace(/(.)\1{2,}/g, '$1$1'); // merciii -> mercii, thaaanks -> thaanks
    
    const stripPunctuation = (str) => 
      str.replace(/[.,!?;:()\\[\\]{}«»"'+=/_<>@#$%^&*|`~،؟…−–—]/g, ' ');
    
    const normalize = (str) => {
      if (!str) return '';
      let s = str.toLowerCase();
      s = removeAccents(s);
      s = removeArabicDiacritics(s);
      s = stripPunctuation(s);
      s = s.replace(/\s+/g, ' ').trim();
      return s;
    };

    // ----------------------------
    // 2. Stop words and synonym mapping
    // ----------------------------
    const stopWords = {
      fr: ['le','la','les','un','une','des','du','de','d','et','ou','est','au','aux','ce','cet','cette','sur','pour','stp','svp','pls','merci','bcp'],
      en: ['the','a','an','of','and','or','is','are','to','in','on','at','please','pls','stp','thanks','thank','thx','thanx'],
      ar: ['من','في','على','عن','الى','إلى','هل','ما','ماذا','كيف','لماذا','وين','وينه','منفضلك','ال','مع','ثم','او','أو']
    };

    // Common synonym/variation mapping for better matching
    const synonymMap = {
      // Thanks variations
      'thx': 'thanks', 'thanx': 'thanks', 'tnx': 'thanks', 'merciii': 'merci', 'mercii': 'merci', 'mercie': 'merci',
      'shukran': 'شكرا', 'شكراً': 'شكرا', 'شكراا': 'شكرا', 'شكرااا': 'شكرا',
      // Location variations
      'lieux': 'lieu', 'localisation': 'lieu', 'location': 'lieu', 'place': 'lieu', 'where': 'where', 'ou': 'où', 'ou?': 'où',
      // Date variations
      'dates': 'date', 'datte': 'date', 'deadline': 'date', 'deadlines': 'date',
      // Congress variations
      'congress': 'congres', 'congrès': 'congres', 'conference': 'congres', 'conf': 'congres'
    };

    const activeStopWords = stopWords[this.locale] || [];
    
    const tokenize = (str) => {
      return normalize(str)
        .split(' ')
        .filter(Boolean)
        .map(collapseRepeats)
        .map(token => synonymMap[token] || token)
        .filter(token => !activeStopWords.includes(token));
    };

    // ----------------------------
    // 3. Similarity calculation helpers
    // ----------------------------
    const levenshtein = (a, b) => {
      if (a === b) return 0;
      const aLen = a.length, bLen = b.length;
      if (!aLen) return bLen;
      if (!bLen) return aLen;
      
      const matrix = Array.from({length: aLen + 1}, () => new Array(bLen + 1));
      for (let i = 0; i <= aLen; i++) matrix[i][0] = i;
      for (let j = 0; j <= bLen; j++) matrix[0][j] = j;
      
      for (let i = 1; i <= aLen; i++) {
        for (let j = 1; j <= bLen; j++) {
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i-1][j] + 1,     // deletion
            matrix[i][j-1] + 1,     // insertion
            matrix[i-1][j-1] + cost // substitution
          );
        }
      }
      return matrix[aLen][bLen];
    };

    const similarity = (a, b) => {
      if (!a || !b) return 0;
      if (a === b) return 1;
      const distance = levenshtein(a, b);
      const maxLength = Math.max(a.length, b.length);
      return 1 - distance / maxLength; // 0 to 1 scale
    };

    // Bigram similarity for better fuzzy matching
    const getBigrams = (str) => {
      const bigrams = [];
      for (let i = 0; i < str.length - 1; i++) {
        bigrams.push(str.slice(i, i + 2));
      }
      return bigrams;
    };

    const jaccardSimilarity = (a, b) => {
      const bigramsA = new Set(getBigrams(a));
      const bigramsB = new Set(getBigrams(b));
      let intersection = 0;
      bigramsA.forEach(bigram => {
        if (bigramsB.has(bigram)) intersection++;
      });
      const union = bigramsA.size + bigramsB.size - intersection;
      return union ? intersection / union : 0;
    };

    // ----------------------------
    // 4. Process user query
    // ----------------------------
    const rawQuery = q || '';
    const normalizedQuery = normalize(rawQuery);
    const userTokensAll = tokenize(rawQuery);
    const userTokens = [...new Set(userTokensAll)]; // Remove duplicates
    
    if (!userTokens.length) {
      const fallback = this.fallback[this.locale];
      return `${fallback} <a href="mailto:info@ciriv.org" class="text-brand-primary underline">info@ciriv.org</a>`;
    }

    // ----------------------------
    // 5. Score each FAQ item
    // ----------------------------
    let bestItem = null;
    let bestScore = 0;

    for (const item of this.faqData) {
      // Get localized question text with fallback
      const questionText = item.question[this.locale] || item.question.en || '';
      const normalizedQuestion = normalize(questionText);
      const questionTokens = tokenize(questionText);

      // Process keywords
      const keywordTokens = (item.keywords || [])
        .map(keyword => tokenize(keyword).join(' '))
        .join(' ')
        .split(' ')
        .filter(Boolean);

      const candidateTokensRaw = [...questionTokens, ...keywordTokens];
      const candidateTokens = [...new Set(candidateTokensRaw)]; // Deduplicate

      if (!candidateTokens.length) continue;

      // --- Component A: Exact token overlap
      let exactMatches = 0;
      userTokens.forEach(userToken => {
        if (candidateTokens.includes(userToken)) exactMatches++;
      });
      const exactScore = exactMatches / userTokens.length; // 0 to 1

      // --- Component B: Fuzzy token matching
      let fuzzyAccumulation = 0;
      userTokens.forEach(userToken => {
        if (candidateTokens.includes(userToken)) return; // Already counted in exact
        
        // Find best similarity with candidate tokens
        let bestLocalSimilarity = 0;
        for (const candidateToken of candidateTokens) {
          const stringSimilarity = similarity(userToken, candidateToken);
          // Bonus for substring matches (e.g., 'regist' vs 'registration')
          const substringBonus = (candidateToken.includes(userToken) || userToken.includes(candidateToken)) ? 0.1 : 0;
          const totalSimilarity = Math.min(1, stringSimilarity + substringBonus);
          
          if (totalSimilarity > bestLocalSimilarity) {
            bestLocalSimilarity = totalSimilarity;
          }
          if (bestLocalSimilarity === 1) break; // Perfect match found
        }
        
        // Only count meaningful fuzzy matches (threshold 0.55)
        if (bestLocalSimilarity >= 0.55) {
          fuzzyAccumulation += bestLocalSimilarity;
        }
      });
      const fuzzyScore = fuzzyAccumulation / userTokens.length; // 0 to 1

      // --- Component C: Keyword prominence boost
      let keywordBoost = 0;
      const keywordSet = new Set((item.keywords || []).map(kw => normalize(kw)));
      userTokens.forEach(userToken => {
        keywordSet.forEach(keyword => {
          if (!keyword) return;
          if (keyword === userToken) {
            keywordBoost += 0.12; // Exact keyword match
          } else {
            const keywordSimilarity = similarity(userToken, keyword);
            if (keywordSimilarity >= 0.8) {
              keywordBoost += 0.08; // Close keyword match
            }
          }
        });
      });
      keywordBoost = Math.min(keywordBoost, 0.35); // Cap the boost

      // --- Component D: Full question similarity (bigrams + Levenshtein)
      const fullLevenshteinSim = similarity(normalizedQuery, normalizedQuestion);
      const fullJaccardSim = jaccardSimilarity(normalizedQuery, normalizedQuestion);
      const fullCompositeSim = (fullLevenshteinSim * 0.6 + fullJaccardSim * 0.4); // 0 to 1

      // --- Aggregate weighted score
      let finalScore = 
        exactScore * 0.45 +        // Exact token matches (highest weight)
        fuzzyScore * 0.30 +        // Fuzzy token matches
        fullCompositeSim * 0.15 +  // Full text similarity
        keywordBoost;              // Keyword prominence (already scaled)

      // Small bonus for very short queries that are fully contained
      if (normalizedQuery.length <= 8 && normalizedQuestion.includes(normalizedQuery)) {
        finalScore += 0.05;
      }

      finalScore = Math.min(finalScore, 1); // Clamp to 1

      if (finalScore > bestScore) {
        bestScore = finalScore;
        bestItem = item;
      }
    }

    // ----------------------------
    // 6. Apply threshold and return result
    // ----------------------------
    const SIMILARITY_THRESHOLD = 0.40;
    
    if (bestItem && bestScore >= SIMILARITY_THRESHOLD) {
      return bestItem.answer[this.locale] || bestItem.answer.en;
    }

    // ----------------------------
    // 7. Fallback response
    // ----------------------------
    const fallback = this.fallback[this.locale];
    return `${fallback} <a href="mailto:info@ciriv.org" class="text-brand-primary underline">info@ciriv.org</a>`;
  }

  addMessage(content, sender){
    if(!this.messages) return;
    const wrap = document.createElement('div');
    if(sender==='user'){
      wrap.className='flex justify-end';
      wrap.innerHTML=`
        <div class="bg-brand-primary text-white rounded-lg p-3 max-w-xs">
          <p class="text-sm">${this.escape(content)}</p>
        </div>`;
    } else {
      wrap.className='flex items-start space-x-2';
      wrap.innerHTML=`
        <div class="w-8 h-8 bg-brand-primary text-white rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="bg-slate-100 rounded-lg p-3 max-w-xs">
          <p class="text-sm text-slate-900">${content}</p>
        </div>`;
    }
    this.messages.appendChild(wrap);
    this.scrollBottom();
  }

  scrollBottom(force=false){
    if(!this.messages) return;
    requestAnimationFrame(()=>{
      this.messages.scrollTop = this.messages.scrollHeight;
      if(force) this.messages.scrollTop = this.messages.scrollHeight;
    });
  }

  onFocus(){
    if(this.mobile){
      this.adjustForKeyboard(true);
      document.body.classList.add('chatlock');
      setTimeout(()=>this.scrollBottom(true),150);
    }
  }

  onBlur(){
    if(this.mobile){
      this.windowEl?.classList.remove('keyboard-shift');
      document.body.classList.remove('chatlock');
      this.adjustForKeyboard();
    }
  }

  adjustForKeyboard(fromFocus=false){
    if(!this.isOpen || !this.mobile || !this.windowEl) return;
    const vv = window.visualViewport;
    if(vv){
      this.windowEl.style.setProperty('--vvh', vv.height+'px');
      if(fromFocus || vv.height < window.innerHeight){
        this.windowEl.classList.add('keyboard-shift');
      } else {
        this.windowEl.classList.remove('keyboard-shift');
      }
    } else {
      // Fallback
      this.windowEl.style.setProperty('--vvh', window.innerHeight+'px');
    }
    this.recalcBodyHeight();
    this.scrollBottom();
  }

  recalcBodyHeight(){
    if(!this.windowEl||!this.messages) return;
    const hHeader = this.header?.offsetHeight || 0;
    const hInput = this.inputWrap?.offsetHeight || 0;
    const total = this.windowEl.offsetHeight;
    const bodyH = total - hHeader - hInput;
    if(bodyH>80) this.messages.style.height = bodyH+'px';
  }

  escape(t){
    const d=document.createElement('div');
    d.textContent=t;
    return d.innerHTML;
  }
}

let chatbot;
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',()=>chatbot=new Chatbot(faqData, locale, fallbackMessages));
}else{
  chatbot=new Chatbot(faqData, locale, fallbackMessages);
}
</script>

<style>
/* Base */
.chat-window { background:#ffffff !important; }
.chat-header { 
  background: var(--brand-primary, #059669) !important; 
  color: white !important;
}
.chat-input-wrapper { background:#ffffff; }
.chat-body { background:#ffffff; }

/* Mobile full view (drawer) */
@media (max-width:767px){
  .chat-window.mobile-full{
    position:fixed !important;
    inset:auto 0 0 0 !important;
    margin:0;
    width:100vw !important;
    max-width:100vw !important;
    border-radius:1.25rem 1.25rem 0 0;
    height:calc(var(--vvh, 100vh) - 56px);
    display:flex;
    flex-direction:column;
    animation:drawer-in .3s ease;
    transform:translateY(0);
  }
  .chat-window.mobile-full.keyboard-shift{
    height:calc(var(--vvh, 100vh) - 8px);
  }
  body.chatlock { overflow:hidden; }
}

/* Animations */
@keyframes drawer-in{
  from { transform:translateY(20px); opacity:0; }
  to { transform:translateY(0); opacity:1; }
}

/* Button pulse */
@keyframes chatbot-pulse {
  0%,100% { transform:scale(1); }
  50% { transform:scale(1.05); }
}
.chatbot-button { animation:chatbot-pulse 4s ease-in-out infinite; animation-delay:2s; }
.chatbot-button:hover, .chat-open .chatbot-button { animation-play-state:paused; }

/* Close button styling */
#chat-minimize {
  min-width: 36px;
  min-height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#chat-minimize:hover {
  background: rgba(255, 255, 255, 0.2) !important;
}

@media (max-width: 767px) {
  #chat-minimize {
    min-width: 44px;
    min-height: 44px;
    padding: 0.75rem !important;
  }
}

/* Scrollbar */
#chat-messages { scroll-behavior:smooth; }
#chat-messages::-webkit-scrollbar { width:6px; }
#chat-messages::-webkit-scrollbar-thumb { background:rgba(0,0,0,.25); border-radius:3px; }

/* Reduced motion */
@media (prefers-reduced-motion:reduce){
  .chatbot-button { animation:none; }
}

/* RTL adjustments (auto via flex classes already) */

/* Safe area (iOS) */
@supports(padding:max(0px)){
  @media (max-width:767px){
    .chat-window.mobile-full{
      padding-bottom: max(0px, env(safe-area-inset-bottom));
    }
  }
}
</style>